{"version":3,"sources":["../src/withFields.js"],"names":["withFields","fields","baseFn","fn","props","__withFields","processing","validation","dirty","getFields","getField","name","populate","data","values","valueKey","value","skipOnPopulate","setValue","validate","invalidFields","field","e","code","WithFieldsError","VALIDATION_FAILED_INVALID_FIELD","message","Object","keys","length","VALIDATION_FAILED_INVALID_FIELDS","clean","isDirty","instance","fieldsList","newFieldName","valueFactory","defineProperty","get","call","getValue","set"],"mappings":"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","sourcesContent":["import { withProps, withStaticProps } from \"repropose\";\nimport { WithFieldsError } from \"@commodo/fields\";\n\nconst withFields = (fields: Object) => {\n    return baseFn => {\n        let fn = withProps(props => {\n            if (props.__withFields) {\n                return {};\n            }\n\n            return {\n                __withFields: {\n                    fields: {},\n                    processing: { validation: false, dirty: false }\n                },\n\n                getFields() {\n                    return this.__withFields.fields;\n                },\n                getField(name) {\n                    return this.__withFields.fields[name];\n                },\n                populate(data) {\n                    if (data && typeof data === \"object\") {\n                        const values = this.getFields();\n                        for (let valueKey in values) {\n                            const value = values[valueKey];\n                            if (!value || value.skipOnPopulate || !(valueKey in data)) {\n                                continue;\n                            }\n\n                            values[valueKey].setValue(data[valueKey]);\n                        }\n                    }\n\n                    return this;\n                },\n\n                async validate() {\n                    if (this.__withFields.processing.validation) {\n                        return;\n                    }\n                    this.__withFields.processing.validation = true;\n\n                    const invalidFields = {};\n                    const fields = this.getFields();\n\n                    for (let name in fields) {\n                        const field = fields[name];\n                        try {\n                            await field.validate();\n                        } catch (e) {\n                            invalidFields[name] = {\n                                code: e.code || WithFieldsError.VALIDATION_FAILED_INVALID_FIELD,\n                                data: e.data || null,\n                                message: e.message\n                            };\n                        }\n                    }\n\n                    this.__withFields.processing.validation = false;\n\n                    if (Object.keys(invalidFields).length > 0) {\n                        throw new WithFieldsError(\n                            \"Validation failed.\",\n                            WithFieldsError.VALIDATION_FAILED_INVALID_FIELDS,\n                            {\n                                invalidFields\n                            }\n                        );\n                    }\n                },\n\n                clean(): void {\n                    const values = this.getFields();\n                    for (let valueKey in values) {\n                        const value = values[valueKey];\n                        value && value.isDirty() && value.clean();\n                    }\n                },\n\n                isDirty(): boolean {\n                    if (this.__withFields.processing.dirty) {\n                        return false;\n                    }\n\n                    this.__withFields.processing.dirty = true;\n\n                    const fields = this.getFields();\n                    for (let valueKey in fields) {\n                        const field = fields[valueKey];\n                        if (field && field.isDirty()) {\n                            this.__withFields.processing.dirty = false;\n                            return true;\n                        }\n                    }\n\n                    this.__withFields.processing.dirty = false;\n                    return false;\n                }\n            };\n        })(baseFn);\n\n        fn = withProps(instance => {\n            let fieldsList = fields;\n            if (typeof fields === \"function\") {\n                fieldsList = fields(instance);\n            }\n\n            for (let newFieldName in fieldsList) {\n                const valueFactory = fieldsList[newFieldName];\n                instance.__withFields.fields[newFieldName] = new valueFactory(\n                    newFieldName,\n                    instance\n                );\n\n                Object.defineProperty(instance, newFieldName, {\n                    get() {\n                        if (this.__withFields.fields[newFieldName].get) {\n                            return this.__withFields.fields[newFieldName].get.call(\n                                this,\n                                this.__withFields.fields[newFieldName]\n                            );\n                        }\n                        return this.__withFields.fields[newFieldName].getValue();\n                    },\n                    set(value) {\n                        if (this.__withFields.fields[newFieldName].set) {\n                            this.__withFields.fields[newFieldName].set.call(\n                                this,\n                                this.__withFields.fields[newFieldName],\n                                value\n                            );\n                        } else {\n                            this.__withFields.fields[newFieldName].setValue(value);\n                        }\n                    }\n                });\n            }\n\n            return {};\n        })(fn);\n\n        fn = withStaticProps({\n            __withFields: true // For satisfying hasFields helper function.\n        })(fn);\n\n        return fn;\n    };\n};\n\nexport default withFields;\n"],"file":"withFields.js"}