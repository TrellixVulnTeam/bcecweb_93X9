{"version":3,"sources":["../../../../src/graphql/upgrades/v5.0.0/index.ts"],"names":["plugin","name","type","app","version","apply","context","elasticsearch","fileManager","db","limit","hasMoreItems","after","undefined","esItems","response","search","defaults","es","body","sort","createdOn","order","unmapped_type","size","hits","length","filter","item","_id","includes","console","log","esJSON","JSON","stringify","file","storage","storagePlugin","upload","buffer","Buffer","from","key","items","batch","create","map","esDb","data","PK","_source","locale","pid","SK","published","index","_index","savedOn","Date","toISOString","execute","operations","delete","errors","bulk","filter_path","warn"],"mappings":"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","sourcesContent":["import { UpgradePlugin } from \"@webiny/api-upgrade/types\";\nimport { PbContext } from \"../../../types\";\nimport { paginateBatch } from \"../utils\";\nimport defaults from \"../../crud/utils/defaults\";\n\nconst plugin: UpgradePlugin<PbContext> = {\n    name: \"api-upgrade-page-builder\",\n    type: \"api-upgrade\",\n    app: \"page-builder\",\n    version: \"5.0.0\",\n    async apply(context) {\n        const { elasticsearch, fileManager, db } = context;\n        const limit = 1000;\n        let hasMoreItems = true;\n        let after = undefined;\n        let esItems = [];\n\n        while (hasMoreItems) {\n            const response = await elasticsearch.search({\n                ...defaults.es(context),\n                body: {\n                    sort: {\n                        createdOn: {\n                            order: \"asc\",\n                            // eslint-disable-next-line\n                            unmapped_type: \"date\"\n                        }\n                    },\n                    size: limit + 1,\n                    after\n                }\n            });\n            const { hits } = response.body.hits;\n\n            hasMoreItems = hits.length > limit;\n            after = hasMoreItems ? hits[limit - 1].sort : undefined;\n            esItems = [...esItems, ...hits.filter(item => !item._id.includes(\"T#root#\"))];\n        }\n\n        console.log(`Fetched ${esItems.length} items from Elasticsearch`);\n        if (esItems.length === 0) {\n            return;\n        }\n\n        // Store a backup of old items\n        const esJSON = JSON.stringify(esItems);\n\n        const { file } = await fileManager.storage.storagePlugin.upload({\n            name: \"upgrade-page-builder-es-5.0.0.json\",\n            type: \"application/json\",\n            size: esJSON.length,\n            buffer: Buffer.from(esJSON)\n        });\n\n        console.log(`Stored backup of Elasticsearch items to ${file.key}`);\n\n        // Store items to ES DDB table\n        await paginateBatch(esItems, 25, async items => {\n            await db\n                .batch()\n                .create(\n                    ...items.map(item => {\n                        return {\n                            ...defaults.esDb,\n                            data: {\n                                PK: `T#root#L#${item._source.locale}#PB#P#${item._source.pid}`,\n                                SK: item._source.published === true ? \"P\" : \"L\",\n                                index: item._index,\n                                data: item._source,\n                                savedOn: new Date().toISOString(),\n                                version: \"5.0.0\"\n                            }\n                        };\n                    })\n                )\n                .execute();\n        });\n\n        console.log(`Inserted items into Elasticsearch DynamoDB table.`);\n\n        // Delete original items from ES index\n        const operations = esItems.map(item => {\n            return { delete: { _id: item._id, _index: item._index } };\n        });\n\n        const {\n            body: { items, errors }\n        } = await elasticsearch.bulk({\n            body: operations,\n            // eslint-disable-next-line\n            filter_path: \"errors,items.*.error\"\n        });\n\n        console.log(`Deleted old Elasticsearch items from \"root-page-builder\" index.`);\n\n        if (errors) {\n            console.warn(\"These items were not deleted\", items);\n        }\n    }\n};\n\nexport default plugin;\n\n// Target _id: T#root#L#en-US#PB#P#603e248312ee4400089d16ec:L\n// Target _id: T#root#L#en-US#PB#P#603e248312ee4400089d16ec:P\n\n// const record = {\n//     _index: \"root-page-builder\",\n//     _type: \"_doc\",\n//     _id: \"P#6026a3873d8f6b0009c67db6\",\n//     _score: 1.0,\n//     _source: {\n//         __type: \"page\",\n//         id: \"6026a3873d8f6b0009c67db6#0001\",\n//         pid: \"6026a3873d8f6b0009c67db6\",\n//         editor: \"page-builder\",\n//         locale: \"en-US\",\n//         createdOn: \"2021-02-12T15:49:27.077Z\",\n//         savedOn: \"2021-02-12T15:49:27.417Z\",\n//         createdBy: {\n//             type: \"admin\",\n//             displayName: \"Pavel Denisjuk\",\n//             id: \"admin@webiny.com\"\n//         },\n//         ownedBy: {\n//             type: \"admin\",\n//             displayName: \"Pavel Denisjuk\",\n//             id: \"admin@webiny.com\"\n//         },\n//         category: \"static\",\n//         version: 1,\n//         title: \"Welcome to Webiny\",\n//         titleLC: \"welcome to webiny\",\n//         path: \"/welcome-to-webiny\",\n//         status: \"published\",\n//         locked: true,\n//         publishedOn: \"2021-02-12T15:49:27.560Z\",\n//         tags: [],\n//         snippet: null,\n//         images: {\n//             general: null\n//         },\n//         published: true\n//     }\n// };\n"],"file":"index.js"}