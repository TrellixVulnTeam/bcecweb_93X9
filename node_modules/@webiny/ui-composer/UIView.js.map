{"version":3,"sources":["../src/UIView.tsx"],"names":["React","useCallback","useState","pWaitFor","Plugin","plugins","UIElement","UIViewID","children","UIView","id","config","Map","useGrid","_props","value","key","hook","_hookDefinitions","viewClass","type","prototype","constructor","name","elPlugins","byType","filter","plugin","canHandle","forEach","apply","getElement","undefined","values","_hookValues","_wrappers","wrapper","push","params","callbacks","Array","from","_events","get","Set","reverse","reduce","data","cb","event","add","set","_isRendered","interval","props","render","UIViewPlugin","_apply","_viewClass","view","UIViewHooks","hooks","getHookDefinitions","setHookValues","Object","keys","acc","UIViewComponent","setCount","wrappers","getWrappers","count","el"],"mappings":"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","sourcesContent":["import React, { useCallback, useState } from \"react\";\nimport pWaitFor from \"p-wait-for\";\nimport { Plugin, plugins } from \"@webiny/plugins\";\nimport { UIElement, UIElementConfig } from \"./UIElement\";\n\nconst UIViewID = ({ children }) => {\n    return children;\n};\n\nexport interface UIElementWrapperProps {\n    children: React.ReactNode;\n    [key: string]: any;\n}\n\nexport interface UIElementWrapper {\n    (props: UIElementWrapperProps): React.ReactElement;\n}\n\nexport class UIView<TConfig = UIElementConfig> extends UIElement<TConfig> {\n    private _events = new Map();\n    private _hookDefinitions: Record<string, Function> = {};\n    private _hookValues: Record<string, any> = {};\n    private _props: { render: Function; [key: string]: any };\n    private _isRendered = false;\n    private _wrappers: UIElementWrapper[] = [];\n\n    constructor(id, config?: TConfig) {\n        super(id, config);\n\n        this.useGrid(false);\n    }\n\n    get props() {\n        return this._props;\n    }\n\n    set props(value) {\n        this._props = value;\n    }\n\n    addHookDefinition(key: string, hook: Function) {\n        this._hookDefinitions[key] = hook;\n    }\n\n    applyPlugins(viewClass: Class<UIView>) {\n        const type = `UIViewPlugin.${viewClass.prototype.constructor.name}`;\n        const elPlugins = plugins.byType<UIViewPlugin<any>>(type);\n        elPlugins\n            .filter(plugin => plugin.canHandle(viewClass))\n            .forEach(plugin => plugin.apply(this));\n    }\n\n    async awaitElement<TElement extends UIElement = UIElement<any>>(id: string): Promise<TElement> {\n        await pWaitFor(() => this.getElement<TElement>(id) !== undefined);\n\n        return this.getElement<TElement>(id);\n    }\n\n    getHookDefinitions() {\n        return this._hookDefinitions;\n    }\n\n    setHookValues(values: Record<string, any>) {\n        this._hookValues = values;\n    }\n\n    getHook<THook = any>(key: string): THook {\n        return this._hookValues[key];\n    }\n\n    getWrappers() {\n        return this._wrappers;\n    }\n\n    wrapWith(wrapper: UIElementWrapper) {\n        // TODO: see if we want to wrap with an instance of an Element, or is a React component enough.\n        this._wrappers.push(wrapper);\n    }\n\n    dispatchEvent(name: string, params = {}) {\n        const callbacks: CallableFunction[] = Array.from(this._events.get(name) || new Set());\n        callbacks.reverse().reduce((data, cb) => cb(data), params);\n    }\n\n    addEventListener(event: string, cb: CallableFunction) {\n        const callbacks = this._events.get(event) || new Set();\n        callbacks.add(cb);\n        this._events.set(event, callbacks);\n    }\n\n    async isRendered() {\n        return pWaitFor(() => this._isRendered, { interval: 50 });\n    }\n\n    render(props?: any): React.ReactNode {\n        // We want to keep track of props that triggered the render cycle.\n        this._props = props;\n\n        // Mark view as rendered\n        this._isRendered = true;\n\n        return <UIViewID key={this.id}>{super.render(props)}</UIViewID>;\n    }\n\n    refresh() {\n        if (this._props && typeof this._props.render === \"function\") {\n            this._props.render();\n        }\n    }\n}\n\nexport interface ApplyFunction<TView> {\n    (view: TView): void;\n}\n\ntype Class<T> = new (...args: any[]) => T;\n\nexport class UIViewPlugin<TView extends any> extends Plugin {\n    public static readonly type: string = \"UIViewPlugin\";\n    private _apply: ApplyFunction<TView>;\n    private _viewClass: Class<TView>;\n\n    constructor(viewClass: Class<TView>, apply: ApplyFunction<TView>) {\n        super();\n\n        this._apply = apply;\n        this._viewClass = viewClass;\n    }\n\n    get type() {\n        return `UIViewPlugin.${this._viewClass.prototype.constructor.name}`;\n    }\n\n    canHandle(viewClass: Class<UIView>) {\n        return viewClass === this._viewClass;\n    }\n\n    apply(view: TView) {\n        this._apply(view);\n    }\n}\n\ninterface UIViewComponentProps {\n    view: UIView;\n    [key: string]: any;\n}\n\nconst UIViewHooks = ({ view, props, render }) => {\n    const hooks = view.getHookDefinitions();\n    if (hooks) {\n        view.setHookValues(\n            Object.keys(hooks).reduce((acc, key) => ({ ...acc, [key]: hooks[key]() }), {})\n        );\n    }\n\n    return view.render({ ...props, render });\n};\n\nexport const UIViewComponent = ({ view, ...props }: UIViewComponentProps): React.ReactElement => {\n    const [, setCount] = useState(0);\n\n    const wrappers = view.getWrappers();\n\n    const render = useCallback(() => {\n        setCount(count => count + 1);\n    }, []);\n\n    return wrappers.reduce((el, wrapper) => {\n        return wrapper({ ...props, children: el });\n    }, <UIViewHooks view={view} render={render} props={props} />);\n};\n"],"file":"UIView.js"}