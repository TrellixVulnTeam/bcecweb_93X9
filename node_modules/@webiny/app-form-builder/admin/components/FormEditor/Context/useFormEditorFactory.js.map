{"version":3,"sources":["../../../../../src/admin/components/FormEditor/Context/useFormEditorFactory.ts"],"names":["React","shortid","GET_FORM","UPDATE_REVISION","getFieldPosition","moveField","moveRow","deleteField","plugins","FormEditorContext","context","useContext","Error","state","dispatch","self","apollo","data","getForm","id","query","variables","revision","decodeURIComponent","response","formBuilder","error","setData","form","settings","layout","renderer","defaultLayoutRenderer","saveForm","mutate","mutation","updateRevision","setter","type","getFields","fields","forEach","row","rowIndex","fieldId","fieldIndex","getField","_id","getFieldPlugin","byType","find","field","key","insertField","position","generate","name","fieldPlugin","Array","isArray","push","source","destination","updateField","fieldData","i","length"],"mappings":"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","sourcesContent":["import React from \"react\";\nimport shortid from \"shortid\";\nimport { cloneDeep, pick } from \"lodash\";\nimport { GET_FORM, UPDATE_REVISION } from \"./graphql\";\nimport { getFieldPosition, moveField, moveRow, deleteField } from \"./functions\";\nimport { plugins } from \"@webiny/plugins\";\n\nimport {\n    FbFormModelFieldsLayout,\n    FbFormModelField,\n    FieldIdType,\n    FieldLayoutPositionType,\n    FbBuilderFieldPlugin\n} from \"../../../../types\";\n\nexport default FormEditorContext => {\n    return () => {\n        // TODO: @ts-adrian add proper type\n        const context = React.useContext<any>(FormEditorContext);\n        if (!context) {\n            throw new Error(\"useFormEditor must be used within a FormEditorProvider\");\n        }\n\n        const { state, dispatch } = context;\n\n        const self = {\n            apollo: state.apollo,\n            data: state.data,\n            state,\n            async getForm(id: string) {\n                const response = await self.apollo.query({\n                    query: GET_FORM,\n                    variables: { revision: decodeURIComponent(id) }\n                });\n                const { data, error } = response?.data?.formBuilder?.getForm || {};\n                if (error) {\n                    throw new Error(error);\n                }\n\n                self.setData(() => {\n                    const form = cloneDeep(data);\n                    if (!form.settings.layout.renderer) {\n                        form.settings.layout.renderer = state.defaultLayoutRenderer;\n                    }\n                    return form;\n                }, false);\n\n                return response;\n            },\n            saveForm: async data => {\n                data = data || state.data;\n                const response = await self.apollo.mutate({\n                    mutation: UPDATE_REVISION,\n                    variables: {\n                        revision: decodeURIComponent(data.id),\n                        data: pick(data, [\"layout\", \"fields\", \"name\", \"settings\", \"triggers\"])\n                    }\n                });\n\n                return response?.data?.formBuilder?.updateRevision;\n            },\n            /**\n             * Set form data by providing a callback, which receives a fresh copy of data on which you can work on.\n             * Return new data once finished.\n             * @param setter\n             * @param saveForm\n             */\n            setData(setter: Function, saveForm = true) {\n                const data = setter(cloneDeep(self.data));\n                dispatch({ type: \"data\", data });\n                saveForm !== false && self.saveForm(data);\n            },\n\n            /**\n             * Returns fields list or complete layout with fields data in it (not just field IDs).\n             * @param layout\n             * @returns {*}\n             */\n            getFields(layout = false): FbFormModelField[] | FbFormModelFieldsLayout {\n                if (!layout) {\n                    return state.data.fields;\n                }\n\n                // Replace every field ID with actual field object.\n                const fields = cloneDeep(state.data.layout);\n                fields.forEach((row, rowIndex) => {\n                    row.forEach((fieldId, fieldIndex) => {\n                        fields[rowIndex][fieldIndex] = self.getField({ _id: fieldId });\n                    });\n                });\n                return fields;\n            },\n\n            /**\n             * Return field plugin.\n             * @param query\n             * @returns {void|?FbFormModelField}\n             */\n            getFieldPlugin(query: object): FbBuilderFieldPlugin {\n                return plugins\n                    .byType<FbBuilderFieldPlugin>(\"form-editor-field-type\")\n                    .find(({ field }) => {\n                        for (const key in query) {\n                            if (!(key in field)) {\n                                return null;\n                            }\n\n                            if (field[key] !== query[key]) {\n                                return null;\n                            }\n                        }\n\n                        return true;\n                    });\n            },\n\n            /**\n             * Checks if field of given type already exists in the list of fields.\n             * @param query\n             * @returns {boolean}\n             */\n            getField(query: object): FbFormModelField {\n                return state.data.fields.find(field => {\n                    for (const key in query) {\n                        if (!(key in field)) {\n                            return null;\n                        }\n\n                        if (field[key] !== query[key]) {\n                            return null;\n                        }\n                    }\n\n                    return true;\n                });\n            },\n\n            /**\n             * Inserts a new field into the target position.\n             * @param data\n             * @param position\n             */\n            insertField(data: FbFormModelField, position: FieldLayoutPositionType) {\n                const field = cloneDeep(data);\n                if (!field._id) {\n                    field._id = shortid.generate();\n                }\n\n                if (!data.name) {\n                    throw new Error(`Field \"name\" missing.`);\n                }\n\n                const fieldPlugin = self.getFieldPlugin({ name: data.name });\n                if (!fieldPlugin) {\n                    throw new Error(`Invalid field \"name\".`);\n                }\n\n                data.type = fieldPlugin.field.type;\n\n                self.setData(data => {\n                    if (!Array.isArray(data.fields)) {\n                        data.fields = [];\n                    }\n                    data.fields.push(field);\n\n                    moveField({ field, position, data });\n\n                    // We are dropping a new field at the specified index.\n                    return data;\n                });\n            },\n\n            /**\n             * Moves field to the given target position.\n             * @param field\n             * @param position\n             * @param data\n             */\n            moveField({\n                field,\n                position\n            }: {\n                field: FieldIdType | FbFormModelField;\n                position: FieldLayoutPositionType;\n            }) {\n                self.setData(data => {\n                    moveField({ field, position, data });\n                    return data;\n                });\n            },\n\n            /**\n             * Moves row to a destination row.\n             * @param source\n             * @param destination\n             */\n            moveRow(source: number, destination: number) {\n                self.setData(data => {\n                    moveRow({ data, source, destination });\n                    return data;\n                });\n            },\n\n            /**\n             * Updates field.\n             * @param fieldData\n             */\n            updateField(fieldData) {\n                const field = cloneDeep(fieldData);\n                self.setData(data => {\n                    for (let i = 0; i < data.fields.length; i++) {\n                        if (data.fields[i]._id === field._id) {\n                            data.fields[i] = field;\n                            break;\n                        }\n                    }\n                    return data;\n                });\n            },\n\n            /**\n             * Deletes a field (both from the list of field and the layout).\n             * @param field\n             */\n            deleteField(field: FbFormModelField) {\n                self.setData(data => {\n                    deleteField({ field, data });\n                    return data;\n                });\n            },\n\n            /**\n             * Returns row / index position for given field.\n             * @param field\n             * @returns {{index: number, row: number}|{index: null, row: null}}\n             */\n            getFieldPosition(field: FieldIdType | FbFormModelField) {\n                return getFieldPosition({ field, data: self.data });\n            }\n        };\n\n        return self;\n    };\n};\n"],"file":"useFormEditorFactory.js"}