{"version":3,"sources":["../../../src/admin/plugins/installation.tsx"],"names":["React","useState","useEffect","lazy","gql","useApolloClient","i18n","Alert","CircularProgress","SimpleForm","SimpleFormContent","styled","SimpleFormPlaceholder","minHeight","minWidth","t","ns","IS_INSTALLED","INSTALL","FBInstaller","onInstalled","client","error","setError","setTimeout","mutate","mutation","variables","domain","window","location","origin","then","data","formBuilder","install","message","label","plugin","name","type","title","dependencies","secure","getInstalledVersion","query","version","render","upgrades","getComponent"],"mappings":"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","sourcesContent":["import React, { useState, useEffect, lazy } from \"react\";\nimport gql from \"graphql-tag\";\nimport { useApolloClient } from \"@apollo/react-hooks\";\nimport { i18n } from \"@webiny/app/i18n\";\nimport { Alert } from \"@webiny/ui/Alert\";\nimport { CircularProgress } from \"@webiny/ui/Progress\";\nimport { SimpleForm, SimpleFormContent } from \"@webiny/app-admin/components/SimpleForm\";\nimport styled from \"@emotion/styled\";\nimport { AdminInstallationPlugin } from \"@webiny/app-admin/types\";\n\nconst SimpleFormPlaceholder = styled.div({\n    minHeight: 300,\n    minWidth: 400\n});\n\nconst t = i18n.ns(\"app-forms/admin/installation\");\n\nconst IS_INSTALLED = gql`\n    query IsFormBuilderInstalled {\n        formBuilder {\n            version\n        }\n    }\n`;\n\nconst INSTALL = gql`\n    mutation InstallFormBuilder($domain: String) {\n        formBuilder {\n            install(domain: $domain) {\n                data\n                error {\n                    code\n                    message\n                }\n            }\n        }\n    }\n`;\n\nconst FBInstaller = ({ onInstalled }) => {\n    const client = useApolloClient();\n    const [error, setError] = useState(null);\n\n    useEffect(() => {\n        // Temporary fix for the ES index creation failure.\n        // Let's try waiting a bit before running the installation.\n        setTimeout(() => {\n            client\n                .mutate({\n                    mutation: INSTALL,\n                    variables: { domain: window.location.origin }\n                })\n                .then(({ data }) => {\n                    const { error } = data.formBuilder.install;\n                    if (error) {\n                        setError(error.message);\n                        return;\n                    }\n\n                    // Just so the user sees the actual message.\n                    setTimeout(onInstalled, 3000);\n                });\n        }, 10000);\n    }, []);\n\n    const label = error ? (\n        <Alert title={t`Something went wrong`} type={\"danger\"}>\n            {error}\n        </Alert>\n    ) : (\n        t`Installing Form Builder...`\n    );\n\n    return (\n        <SimpleForm>\n            <CircularProgress label={label} />\n            <SimpleFormContent>\n                <SimpleFormPlaceholder />\n            </SimpleFormContent>\n        </SimpleForm>\n    );\n};\n\nconst plugin: AdminInstallationPlugin = {\n    name: \"admin-installation-fb\",\n    type: \"admin-installation\",\n    title: t`Form Builder`,\n    dependencies: [\"admin-installation-security\"],\n    secure: true,\n    async getInstalledVersion({ client }) {\n        const { data } = await client.query({ query: IS_INSTALLED });\n        return data.formBuilder.version;\n    },\n    render({ onInstalled }) {\n        return <FBInstaller onInstalled={onInstalled} />;\n    },\n    upgrades: [\n        {\n            version: \"5.0.0\",\n            getComponent() {\n                return lazy(() => import(\"./upgrades/v5.0.0\"));\n            }\n        }\n    ]\n};\n\nexport default plugin;\n"],"file":"installation.js"}