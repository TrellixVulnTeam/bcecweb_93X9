import _objectSpread from "@babel/runtime/helpers/objectSpread2";
import _asyncToGenerator from "@babel/runtime/helpers/asyncToGenerator";
import _regeneratorRuntime from "@babel/runtime/regenerator";
import { Auth } from "@aws-amplify/auth";
import { setContext } from "apollo-link-context";
import { ApolloLinkPlugin } from "@webiny/app/plugins/ApolloLinkPlugin";
export default (function (options) {
  Auth.configure(options);
  return [new ApolloLinkPlugin(function () {
    return setContext( /*#__PURE__*/function () {
      var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(_, _ref) {
        var headers, user, idToken;
        return _regeneratorRuntime.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                headers = _ref.headers;
                _context.prev = 1;
                _context.next = 4;
                return Auth.currentSession();

              case 4:
                user = _context.sent;
                _context.next = 10;
                break;

              case 7:
                _context.prev = 7;
                _context.t0 = _context["catch"](1);
                console.error(_context.t0);

              case 10:
                if (user) {
                  _context.next = 12;
                  break;
                }

                return _context.abrupt("return", {
                  headers: headers
                });

              case 12:
                if (!(headers && headers.Authorization)) {
                  _context.next = 14;
                  break;
                }

                return _context.abrupt("return", {
                  headers: headers
                });

              case 14:
                idToken = user.getIdToken().getJwtToken();
                return _context.abrupt("return", {
                  headers: _objectSpread(_objectSpread({}, headers), {}, {
                    Authorization: "Bearer ".concat(idToken)
                  })
                });

              case 16:
              case "end":
                return _context.stop();
            }
          }
        }, _callee, null, [[1, 7]]);
      }));

      return function (_x, _x2) {
        return _ref2.apply(this, arguments);
      };
    }());
  })];
});
//# sourceMappingURL=index.js.map