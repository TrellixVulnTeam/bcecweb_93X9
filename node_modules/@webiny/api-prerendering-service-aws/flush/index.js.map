{"version":3,"sources":["../../src/flush/index.ts"],"names":["type","afterFlush","log","render","args","configuration","distributionId","meta","cloudfront","path","url","parse","pathname","CloudFront","createInvalidation","DistributionId","InvalidationBatch","CallerReference","Date","getTime","Paths","Quantity","Items","promise","e","console","stack"],"mappings":";;;;;;;;;AACA;;AACA;;AAEA;AACA;eACe,MAAM;AACjB,SAAO;AACHA,IAAAA,IAAI,EAAE,eADH;AAEHC,IAAAA,UAAU,EAAE,OAAO;AAAEC,MAAAA,GAAF;AAAOC,MAAAA;AAAP,KAAP,KAA2B;AAAA;;AACnC,UAAI,CAACA,MAAL,EAAa;AACT;AACH;;AAED,YAAM;AAAEC,QAAAA,IAAF;AAAQC,QAAAA;AAAR,UAA0BF,MAAhC,CALmC,CAMnC;;AACAD,MAAAA,GAAG,CAAC,2DAAD,CAAH;AAEA,UAAII,cAAc,GAAGF,IAAH,aAAGA,IAAH,8CAAGA,IAAI,CAAEC,aAAT,iFAAG,oBAAqBE,IAAxB,oFAAG,sBAA2BC,UAA9B,2DAAG,uBAAuCF,cAA5D;;AACA,UAAI,CAACA,cAAL,EAAqB;AAAA;;AACjBA,QAAAA,cAAc,GAAGD,aAAH,aAAGA,aAAH,8CAAGA,aAAa,CAAEE,IAAlB,iFAAG,oBAAqBC,UAAxB,0DAAG,sBAAiCF,cAAlD;AACH;;AAED,UAAI,CAACA,cAAL,EAAqB;AACjBJ,QAAAA,GAAG,CAAE,sDAAF,CAAH;AACA;AACH;;AAEDA,MAAAA,GAAG,CAAC,wDAAD,CAAH;AACA,UAAIO,IAAI,GAAGL,IAAI,CAACK,IAAhB;;AACA,UAAI,CAACA,IAAL,EAAW;AACPP,QAAAA,GAAG,CAAE,6EAAF,CAAH;AACAO,QAAAA,IAAI,GAAGC,aAAIC,KAAJ,CAAUP,IAAI,CAACM,GAAf,EAAoBE,QAA3B;AACH;;AAED,UAAI,CAACH,IAAL,EAAW;AACPP,QAAAA,GAAG,CAAE,iEAAF,CAAH;AACA;AACH;;AAEDO,MAAAA,IAAI,IAAI,GAAR;AAEAP,MAAAA,GAAG,CACE,oFAAmFI,cAAe,YAAWG,IAAK,IADpH,CAAH;AAIA,YAAMD,UAAU,GAAG,IAAIK,mBAAJ,EAAnB;;AACA,UAAI;AACA,cAAML,UAAU,CACXM,kBADC,CACkB;AAChBC,UAAAA,cAAc,EAAET,cADA;AAEhBU,UAAAA,iBAAiB,EAAE;AACfC,YAAAA,eAAe,EAAG,GAAE,IAAIC,IAAJ,GAAWC,OAAX,EAAqB,wCAD1B;AAEfC,YAAAA,KAAK,EAAE;AACHC,cAAAA,QAAQ,EAAE,CADP;AAEHC,cAAAA,KAAK,EAAE,CAACb,IAAD;AAFJ;AAFQ;AAFH,SADlB,EAWDc,OAXC,EAAN;AAYH,OAbD,CAaE,OAAOC,CAAP,EAAU;AACR;AACAC,QAAAA,OAAO,CAACvB,GAAR,CACK,4EAA2EI,cAAe,IAD/F,EAEIkB,CAAC,CAACE,KAFN;AAIH;;AAEDD,MAAAA,OAAO,CAACvB,GAAR,CAAa,qCAAoCO,IAAK,yBAAtD;AACH;AA9DE,GAAP;AAgEH,C","sourcesContent":["import { FlushHookPlugin } from \"@webiny/api-prerendering-service/flush/types\";\nimport CloudFront from \"aws-sdk/clients/cloudfront\";\nimport url from \"url\";\n\n// This plugin will issue a cache invalidation request to CloudFront, every time a page has been deleted. This is\n// mostly important when a user unpublishes a new page, and we want to make the page immediately publicly available.\nexport default () => {\n    return {\n        type: \"ps-flush-hook\",\n        afterFlush: async ({ log, render }) => {\n            if (!render) {\n                return;\n            }\n\n            const { args, configuration } = render;\n            // Let's create a cache invalidation request.\n            log(\"Trying to send a CloudFront cache invalidation request...\");\n\n            let distributionId = args?.configuration?.meta?.cloudfront?.distributionId;\n            if (!distributionId) {\n                distributionId = configuration?.meta?.cloudfront?.distributionId;\n            }\n\n            if (!distributionId) {\n                log(`Exiting... CloudFront \"distributionId\" not provided.`);\n                return;\n            }\n\n            log(\"Trying to get the path that needs to be invalidated...\");\n            let path = args.path;\n            if (!path) {\n                log(`Path wasn't passed via \"args.path\", trying to extract it from \"args.url\"...`);\n                path = url.parse(args.url).pathname;\n            }\n\n            if (!path) {\n                log(`Aborting the cache invalidation attempt... \"path\" not detected.`);\n                return;\n            }\n\n            path += \"*\";\n\n            log(\n                `Proceeding with issuing a cache invalidation request to CloudFront distribution \"${distributionId}\", path \"${path}\".`\n            );\n\n            const cloudfront = new CloudFront();\n            try {\n                await cloudfront\n                    .createInvalidation({\n                        DistributionId: distributionId,\n                        InvalidationBatch: {\n                            CallerReference: `${new Date().getTime()}-api-prerender-service-aws-after-flush`,\n                            Paths: {\n                                Quantity: 1,\n                                Items: [path]\n                            }\n                        }\n                    })\n                    .promise();\n            } catch (e) {\n                // eslint-disable-next-line\n                console.log(\n                    `Failed to issue a cache invalidation request to CloudFront distribution \"${distributionId}\".`,\n                    e.stack\n                );\n            }\n\n            console.log(`Cache invalidation request (path \"${path}\") successfully issued.`);\n        }\n    } as FlushHookPlugin;\n};\n"],"file":"index.js"}