"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _path = _interopRequireDefault(require("path"));

var _s = _interopRequireDefault(require("aws-sdk/clients/s3"));

var _utils = require("../utils");

var _managers = _interopRequireDefault(require("../transform/managers"));

var _default = () => ({
  type: "handler",
  name: "handler-download-file",

  async handle(context) {
    const event = context.invocationArgs;
    const handler = (0, _utils.createHandler)(async event => {
      const keys = [];

      for (let i = 0; i < event.Records.length; i++) {
        const record = event.Records[i];

        if (typeof record.s3.object.key === "string") {
          keys.push(record.s3.object.key);
        }
      }

      const {
        region
      } = (0, _utils.getEnvironment)();
      const s3 = new _s.default({
        region
      });

      for (let i = 0; i < keys.length; i++) {
        const key = keys[i];

        const extension = _path.default.extname(key);

        for (let j = 0; j < _managers.default.length; j++) {
          const manager = _managers.default[j];
          const canProcess = manager.canProcess({
            s3,
            key,
            extension
          });

          if (canProcess) {
            await manager.process({
              s3,
              key,
              extension
            });
          }
        }
      }
    });
    return await handler(event);
  }

});

exports.default = _default;
//# sourceMappingURL=index.js.map