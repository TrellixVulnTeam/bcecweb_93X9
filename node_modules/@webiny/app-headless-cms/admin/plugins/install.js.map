{"version":3,"sources":["../../../src/admin/plugins/install.tsx"],"names":["React","useState","useEffect","lazy","gql","useApolloClient","i18n","Alert","CircularProgress","SimpleForm","SimpleFormContent","styled","SimpleFormPlaceholder","minHeight","minWidth","t","ns","IS_INSTALLED","INSTALL","CMSInstaller","onInstalled","client","error","setError","setTimeout","mutate","mutation","then","data","cms","install","message","label","plugin","name","type","title","dependencies","secure","getInstalledVersion","query","version","render","upgrades","getComponent"],"mappings":"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","sourcesContent":["import React, { useState, useEffect, lazy } from \"react\";\nimport gql from \"graphql-tag\";\nimport { useApolloClient } from \"@apollo/react-hooks\";\nimport { i18n } from \"@webiny/app/i18n\";\nimport { Alert } from \"@webiny/ui/Alert\";\nimport { CircularProgress } from \"@webiny/ui/Progress\";\nimport { SimpleForm, SimpleFormContent } from \"@webiny/app-admin/components/SimpleForm\";\nimport styled from \"@emotion/styled\";\nimport { AdminInstallationPlugin } from \"@webiny/app-admin/types\";\n\nconst SimpleFormPlaceholder = styled.div({\n    minHeight: 300,\n    minWidth: 400\n});\n\nconst t = i18n.ns(\"app-headless-cms/admin/installation\");\n\nconst IS_INSTALLED = gql`\n    query IsCMSInstalled {\n        cms {\n            version\n        }\n    }\n`;\n\nconst INSTALL = gql`\n    mutation InstallCms {\n        cms {\n            install {\n                data\n                error {\n                    code\n                    message\n                    data\n                }\n            }\n        }\n    }\n`;\n\nconst CMSInstaller = ({ onInstalled }) => {\n    const client = useApolloClient();\n    const [error, setError] = useState(null);\n\n    useEffect(() => {\n        // Temporary fix for the ES index creation failure.\n        // Let's try waiting a bit before running the installation.\n        setTimeout(() => {\n            client\n                .mutate({\n                    mutation: INSTALL\n                })\n                .then(({ data }) => {\n                    const { error } = data.cms.install;\n                    if (error) {\n                        setError(error.message);\n                        return;\n                    }\n\n                    // Just so the user sees the actual message.\n                    setTimeout(onInstalled, 3000);\n                });\n        }, 10000);\n    }, []);\n\n    const label = error ? (\n        <Alert title={t`Something went wrong`} type={\"danger\"}>\n            {error}\n        </Alert>\n    ) : (\n        t`Installing Headless CMS...`\n    );\n\n    return (\n        <SimpleForm>\n            <CircularProgress label={label} />\n            <SimpleFormContent>\n                <SimpleFormPlaceholder />\n            </SimpleFormContent>\n        </SimpleForm>\n    );\n};\n\nconst plugin: AdminInstallationPlugin = {\n    name: \"admin-installation-cms\",\n    type: \"admin-installation\",\n    title: t`Headless CMS`,\n    dependencies: [\"admin-installation-security\", \"admin-installation-i18n\"],\n    secure: true,\n    async getInstalledVersion({ client }) {\n        const { data } = await client.query({ query: IS_INSTALLED });\n        return data.cms.version;\n    },\n    render({ onInstalled }) {\n        return <CMSInstaller onInstalled={onInstalled} />;\n    },\n    upgrades: [\n        {\n            version: \"5.0.0\",\n            getComponent() {\n                return lazy(() => import(\"./upgrades/v5.0.0\"));\n            }\n        },\n        {\n            version: \"5.5.0\",\n            getComponent() {\n                return lazy(() => import(\"./upgrades/v5.5.0\"));\n            }\n        },\n        {\n            version: \"5.8.0\",\n            getComponent() {\n                return lazy(() => import(\"./upgrades/v5.8.0\"));\n            }\n        }\n    ]\n};\n\nexport default plugin;\n"],"file":"install.js"}