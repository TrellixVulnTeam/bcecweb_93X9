import _asyncToGenerator from "@babel/runtime/helpers/asyncToGenerator";
import _regeneratorRuntime from "@babel/runtime/regenerator";
import React from "react";
import { useRecoilValue } from "recoil";
import { css } from "emotion";
import merge from "lodash/merge";
import set from "lodash/set";
import get from "lodash/get";
import { Form } from "@webiny/form";
import { plugins } from "@webiny/plugins";
import { Tooltip } from "@webiny/ui/Tooltip";
import { useEventActionHandler } from "../../../hooks/useEventActionHandler";
import { UpdateElementActionEvent } from "../../../../editor/recoil/actions";
import { activeElementAtom, elementWithChildrenByIdSelector, uiAtom } from "../../../../editor/recoil/modules"; // Components

import Accordion from "../components/Accordion";
import Wrapper from "../components/Wrapper";
import SpacingPicker from "../components/SpacingPicker";
import { classes } from "../components/StyledComponents";
import { applyFallbackDisplayMode } from "../elementSettingsUtils";
var rightCellStyle = /*#__PURE__*/css({
  justifySelf: "end"
}, "label:rightCellStyle;");
var spacingPickerStyle = /*#__PURE__*/css({
  width: "120px",
  "& .inner-wrapper": {
    display: "flex"
  }
}, "label:spacingPickerStyle;");
var widthUnitOptions = [{
  label: "%",
  value: "%"
}, {
  label: "px",
  value: "px"
}, {
  label: "em",
  value: "em"
}, {
  label: "vw",
  value: "vw"
}, {
  label: "auto",
  value: "auto"
}];
var WidthUnits;

(function (WidthUnits) {
  WidthUnits["percentage"] = "%";
  WidthUnits["px"] = "px";
  WidthUnits["em"] = "em";
  WidthUnits["vw"] = "vw";
  WidthUnits["auto"] = "auto";
})(WidthUnits || (WidthUnits = {}));

var validateWidth = function validateWidth(value) {
  if (!value) {
    return null;
  }

  var parsedValue = parseInt(value);

  if (isNaN(parsedValue) && value !== WidthUnits.auto) {
    throw Error("Enter a valid number!");
  }

  if (parsedValue < 0) {
    throw Error("Value can't be negative!");
  }

  if (value.endsWith(WidthUnits.percentage) || value.endsWith(WidthUnits.px) || value.endsWith(WidthUnits.em) || value.endsWith(WidthUnits.vw) || value.endsWith(WidthUnits.auto)) {
    return true;
  }

  throw Error("Specify a valid value!");
};

var DATA_NAMESPACE = "data.settings.width";

var Settings = function Settings(_ref) {
  var defaultAccordionValue = _ref.defaultAccordionValue;

  var _useRecoilValue = useRecoilValue(uiAtom),
      displayMode = _useRecoilValue.displayMode;

  var activeElementId = useRecoilValue(activeElementAtom);
  var element = useRecoilValue(elementWithChildrenByIdSelector(activeElementId));
  var handler = useEventActionHandler();

  var updateSettings = /*#__PURE__*/function () {
    var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(data, form) {
      var valid, newElement;
      return _regeneratorRuntime.wrap(function _callee$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              _context.next = 2;
              return form.validate();

            case 2:
              valid = _context.sent;

              if (valid) {
                _context.next = 5;
                break;
              }

              return _context.abrupt("return");

            case 5:
              newElement = merge({}, element, set({}, "".concat(DATA_NAMESPACE, ".").concat(displayMode), data));
              return _context.abrupt("return", handler.trigger(new UpdateElementActionEvent({
                element: newElement,
                history: true
              })));

            case 7:
            case "end":
              return _context.stop();
          }
        }
      }, _callee);
    }));

    return function updateSettings(_x, _x2) {
      return _ref2.apply(this, arguments);
    };
  }();

  var _React$useMemo = React.useMemo(function () {
    return plugins.byType("pb-editor-responsive-mode").find(function (pl) {
      return pl.config.displayMode === displayMode;
    });
  }, [displayMode]),
      activeDisplayModeConfig = _React$useMemo.config;

  var settings = React.useMemo(function () {
    var fallbackValue = applyFallbackDisplayMode(displayMode, function (mode) {
      return get(element, "".concat(DATA_NAMESPACE, ".").concat(mode));
    });
    return get(element, "".concat(DATA_NAMESPACE, ".").concat(displayMode), fallbackValue || {
      value: "100%"
    });
  }, [displayMode, element]);
  return /*#__PURE__*/React.createElement(Accordion, {
    title: "Width",
    defaultValue: defaultAccordionValue,
    icon: /*#__PURE__*/React.createElement(Tooltip, {
      content: "Changes will apply for ".concat(activeDisplayModeConfig.displayMode)
    }, activeDisplayModeConfig.icon)
  }, /*#__PURE__*/React.createElement(Form, {
    data: settings,
    onChange: updateSettings
  }, function (_ref3) {
    var Bind = _ref3.Bind;
    return /*#__PURE__*/React.createElement(Wrapper, {
      label: "Width",
      containerClassName: classes.simpleGrid,
      rightCellClassName: rightCellStyle
    }, /*#__PURE__*/React.createElement(Bind, {
      name: "value",
      validators: validateWidth
    }, function (_ref4) {
      var value = _ref4.value,
          onChange = _ref4.onChange,
          validation = _ref4.validation;
      return /*#__PURE__*/React.createElement(SpacingPicker, {
        value: value,
        onChange: onChange,
        validation: validation,
        options: widthUnitOptions,
        className: spacingPickerStyle,
        useDefaultStyle: false
      });
    }));
  }));
};

export default /*#__PURE__*/React.memo(Settings);
//# sourceMappingURL=WidthSettings.js.map