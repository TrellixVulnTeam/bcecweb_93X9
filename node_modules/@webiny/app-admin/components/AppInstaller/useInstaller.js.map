{"version":3,"sources":["../../../src/components/AppInstaller/useInstaller.tsx"],"names":["React","useCallback","useReducer","useEffect","Suspense","Graph","alg","sort","gt","lte","useApolloClient","plugins","CircularProgress","Loader","children","props","cloneElement","useInstaller","prev","next","loading","installers","installerIndex","showLogin","skippingVersions","setState","client","validateGraph","graph","isAcyclic","cycles","findCycles","msg","forEach","cycle","index","fromAToB","join","fromBToA","reverse","padLength","length","push","padStart","Error","createGraph","plugin","setNode","name","pl","Array","isArray","dependencies","dep","setEdge","getInstallers","toInstall","toUpgrade","leaf","sinks","installer","find","inst","removeNode","installed","type","title","render","secure","upgrades","filter","version","process","env","REACT_APP_WEBINY_VERSION","availableUpgrades","map","u","latestUpgrade","current","latest","onInstalled","Component","getComponent","onUser","showNextInstaller","prevInstaller","nextIndex","nextInstaller","prevSecure","nextSecure","allInstallers","Promise","all","byType","getInstalledVersion"],"mappings":"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","sourcesContent":["import React, { useCallback, useReducer, useEffect, Suspense } from \"react\";\nimport { Graph, alg } from \"graphlib\";\nimport { sort, gt, lte } from \"semver\";\nimport { useApolloClient } from \"@apollo/react-hooks\";\nimport { plugins } from \"@webiny/plugins\";\nimport { AdminInstallationPlugin } from \"../../types\";\nimport { CircularProgress } from \"@webiny/ui/Progress\";\n\nconst Loader = ({ children, ...props }) => (\n    <Suspense fallback={<CircularProgress label={\"Loading...\"} />}>\n        {React.cloneElement(children, props)}\n    </Suspense>\n);\n\nexport const useInstaller = () => {\n    const [{ loading, installers, installerIndex, showLogin, skippingVersions }, setState] =\n        useReducer((prev, next) => ({ ...prev, ...next }), {\n            loading: true,\n            installers: [],\n            installerIndex: -1,\n            showLogin: false,\n            skippingVersions: false\n        });\n\n    const client = useApolloClient();\n\n    const validateGraph = graph => {\n        const isAcyclic = alg.isAcyclic(graph);\n        if (!isAcyclic) {\n            const cycles = alg.findCycles(graph);\n            const msg = [\"Your installers have circular dependencies:\"];\n            cycles.forEach((cycle, index) => {\n                let fromAToB = cycle.join(\" --> \");\n                fromAToB = `${index + 1}. ${fromAToB}`;\n                const fromBToA = cycle.reverse().join(\" <-- \");\n                const padLength = fromAToB.length + 4;\n                msg.push(fromAToB.padStart(padLength));\n                msg.push(fromBToA.padStart(padLength));\n            }, cycles);\n            throw new Error(msg.join(\"\\n\"));\n        }\n    };\n\n    const createGraph = installers => {\n        const graph = new Graph();\n        installers.forEach(({ plugin }) => {\n            graph.setNode(plugin.name, plugin);\n        });\n\n        installers.forEach(({ plugin: pl }) => {\n            if (Array.isArray(pl.dependencies)) {\n                pl.dependencies.forEach(dep => {\n                    graph.setEdge(pl.name, dep);\n                });\n            }\n        });\n\n        validateGraph(graph);\n\n        return graph;\n    };\n\n    const getInstallers = useCallback((installers, graph, toInstall = [], toUpgrade = []) => {\n        const leaf = graph.sinks()[0];\n        if (leaf) {\n            const installer = installers.find(inst => inst.plugin.name === leaf);\n            if (!installer) {\n                throw new Error(`Missing installer plugin \"${leaf}\"!`);\n            }\n\n            graph.removeNode(leaf);\n            if (!installer.installed) {\n                toInstall.push({\n                    type: \"install\",\n                    name: `${installer.plugin.name}-install`,\n                    title: installer.plugin.title,\n                    render: installer.plugin.render,\n                    secure: installer.plugin.secure,\n                    installed: false\n                });\n            } else {\n                const upgrades = (installer.plugin.upgrades || []).filter(({ version }) => {\n                    return (\n                        lte(version, process.env.REACT_APP_WEBINY_VERSION) &&\n                        gt(version, installer.installed)\n                    );\n                });\n\n                if (upgrades.length > 1) {\n                    const availableUpgrades = sort(upgrades.map(u => u.version));\n                    const latestUpgrade = availableUpgrades[availableUpgrades.length - 1];\n                    setState({\n                        skippingVersions: {\n                            current: installer.installed,\n                            latest: latestUpgrade,\n                            availableUpgrades\n                        }\n                    });\n                } else if (upgrades.length === 1) {\n                    toUpgrade.push({\n                        type: \"upgrade\",\n                        name: `${installer.plugin.name}-upgrade`,\n                        title: installer.plugin.title,\n                        secure: true,\n                        installed: false,\n                        render({ onInstalled }) {\n                            const Component = upgrades[0].getComponent();\n                            return (\n                                <Loader>\n                                    <Component onInstalled={onInstalled} />\n                                </Loader>\n                            );\n                        }\n                    });\n                }\n            }\n            return getInstallers(installers, graph, toInstall, toUpgrade);\n        }\n        return { toInstall, toUpgrade };\n    }, []);\n\n    const onUser = () => {\n        setState({ showLogin: false });\n    };\n\n    const showNextInstaller = () => {\n        const prevInstaller = installers[installerIndex];\n\n        installers[installerIndex].installed = true;\n        setState({ installers });\n\n        if (installers.length < installerIndex + 1) {\n            setState({ installerIndex: null });\n            return;\n        }\n\n        const nextIndex = installerIndex + 1;\n\n        let showLogin = false;\n        const nextInstaller = installers[nextIndex];\n\n        const prevSecure = prevInstaller && prevInstaller.secure;\n        const nextSecure = nextInstaller && nextInstaller.secure;\n        if (!prevSecure && nextSecure) {\n            showLogin = true;\n        }\n        setState({ installerIndex: nextIndex, showLogin });\n    };\n\n    useEffect(() => {\n        (async () => {\n            const allInstallers = [];\n            await Promise.all(\n                plugins.byType<AdminInstallationPlugin>(\"admin-installation\").map(async pl => {\n                    const installed = await pl.getInstalledVersion({ client });\n                    allInstallers.push({ plugin: pl, installed });\n                })\n            );\n\n            const graph = createGraph(allInstallers);\n            const { toInstall, toUpgrade } = getInstallers(allInstallers, graph);\n            const installers = [...toUpgrade, ...toInstall];\n            setState({\n                installers,\n                installerIndex: 0,\n                loading: false,\n                showLogin: toUpgrade.length > 0 || (toInstall.length > 0 && toInstall[0].secure)\n            });\n        })();\n    }, []);\n\n    return {\n        loading,\n        installers,\n        installer: installers[installerIndex],\n        showNextInstaller,\n        showLogin,\n        onUser,\n        skippingVersions\n    };\n};\n"],"file":"useInstaller.js"}