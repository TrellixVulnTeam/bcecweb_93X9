{"version":3,"sources":["../../../src/graphql/crud/locales.crud.ts"],"names":["ContextPlugin","context","i18n","pluginType","LocalesStorageOperationsProviderPlugin","type","providerPlugin","plugins","byType","find","WebinyError","storageOperations","provide","localePlugins","LocalePlugin","locales","getDefault","locale","NotFoundError","createdOn","Date","toISOString","ex","message","code","get","list","params","where","sort","after","limit","length","create","input","security","tenancy","permission","getPermission","NotAuthorizedError","original","identity","getIdentity","defaultLocale","default","createdBy","id","displayName","tenant","getCurrentTenant","webinyVersion","WEBINY_VERSION","data","result","updateDefault","previous","update","delete","allLocales"],"mappings":"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","sourcesContent":["import { I18NContext, I18NContextObject, I18NLocale } from \"~/types\";\nimport { ContextPlugin } from \"@webiny/handler/plugins/ContextPlugin\";\nimport WebinyError from \"@webiny/error\";\nimport { NotFoundError } from \"@webiny/handler-graphql\";\nimport { NotAuthorizedError } from \"@webiny/api-security\";\nimport { LocalesStorageOperationsProviderPlugin } from \"~/plugins/LocalesStorageOperationsProviderPlugin\";\nimport { LocalePlugin } from \"~/plugins/LocalePlugin\";\nimport { runLifecycleEvent } from \"./locales/lifecycleEvent\";\n\nexport default new ContextPlugin<I18NContext>(async context => {\n    if (!context.i18n) {\n        context.i18n = {} as I18NContextObject;\n    }\n    const pluginType = LocalesStorageOperationsProviderPlugin.type;\n\n    const providerPlugin = context.plugins\n        .byType<LocalesStorageOperationsProviderPlugin>(pluginType)\n        .find(() => true);\n\n    if (!providerPlugin) {\n        throw new WebinyError(`Missing \"${pluginType}\" plugin.`, \"PLUGIN_NOT_FOUND\", {\n            type: pluginType\n        });\n    }\n\n    const storageOperations = await providerPlugin.provide({\n        context\n    });\n\n    const localePlugins = context.plugins.byType<LocalePlugin>(LocalePlugin.type);\n\n    context.i18n.locales = {\n        getDefault: async () => {\n            try {\n                const locale = await storageOperations.getDefault();\n                if (!locale) {\n                    throw new NotFoundError(`Default locale  not found.`);\n                }\n                return {\n                    ...locale,\n                    createdOn: locale.createdOn ? locale.createdOn : new Date().toISOString()\n                };\n            } catch (ex) {\n                throw new WebinyError(\n                    ex.message || \"Could not load the default locale.\",\n                    ex.code || \"LOCALE_DEFAULT_ERROR\"\n                );\n            }\n        },\n        get: async code => {\n            try {\n                const locale = await storageOperations.get(code);\n                if (!locale) {\n                    throw new NotFoundError(`Locale \"${code}\" not found.`);\n                }\n                return {\n                    ...locale,\n                    createdOn: locale.createdOn ? locale.createdOn : new Date().toISOString()\n                };\n            } catch (ex) {\n                throw new WebinyError(\n                    ex.message || \"Could not load the requested locale.\",\n                    ex.code || \"LOCALE_GET_ERROR\",\n                    {\n                        code\n                    }\n                );\n            }\n        },\n\n        list: async params => {\n            const { where, sort, after, limit = 1000 } = params || {};\n            try {\n                return await storageOperations.list({\n                    where,\n                    sort: sort && sort.length ? sort : [\"createdOn_DESC\"],\n                    after,\n                    limit\n                });\n            } catch (ex) {\n                throw new WebinyError(\n                    ex.message || \"Could not load the all the locales.\",\n                    ex.code || \"LOCALE_LIST_ERROR\"\n                );\n            }\n        },\n\n        create: async input => {\n            const { security, tenancy } = context;\n\n            const permission = await security.getPermission(\"i18n.locale\");\n\n            if (!permission) {\n                throw new NotAuthorizedError();\n            }\n\n            const original = await storageOperations.get(input.code);\n\n            if (original) {\n                throw new WebinyError(`Locale with key \"${original.code}\" already exists.`);\n            }\n\n            const identity = security.getIdentity();\n\n            const defaultLocale = await storageOperations.getDefault();\n\n            const locale: I18NLocale = {\n                ...input,\n                default: input.default === true,\n                createdOn: new Date().toISOString(),\n                createdBy: {\n                    id: identity.id,\n                    displayName: identity.displayName,\n                    type: identity.type\n                },\n                tenant: tenancy.getCurrentTenant().id,\n                webinyVersion: context.WEBINY_VERSION\n            };\n\n            try {\n                await runLifecycleEvent(\"beforeCreate\", {\n                    context,\n                    plugins: localePlugins,\n                    data: locale\n                });\n                const result = await storageOperations.create({\n                    locale\n                });\n                if (locale.default) {\n                    await storageOperations.updateDefault({\n                        previous: defaultLocale,\n                        locale: result\n                    });\n                }\n                await runLifecycleEvent(\"afterCreate\", {\n                    context,\n                    plugins: localePlugins,\n                    data: locale,\n                    locale: result\n                });\n                return locale;\n            } catch (ex) {\n                throw new WebinyError(\n                    ex.message || \"Could not create new locale.\",\n                    ex.code || \"LOCALE_CREATE_ERROR\",\n                    {\n                        input,\n                        locale,\n                        defaultLocale\n                    }\n                );\n            }\n        },\n\n        update: async (code, input) => {\n            const { i18n, security } = context;\n\n            const permission = await security.getPermission(\"i18n.locale\");\n\n            if (!permission) {\n                throw new NotAuthorizedError();\n            }\n            const original = await i18n.locales.get(code);\n            if (!original) {\n                throw new NotFoundError(`Locale \"${code}\" not found.`);\n            }\n            if (original.default && !input.default) {\n                throw new WebinyError(\n                    \"Cannot unset default locale, please set another locale as default first.\",\n                    \"CANNOT_CHANGE_DEFAULT_LOCALE\",\n                    {\n                        original,\n                        input\n                    }\n                );\n            }\n            const defaultLocale = original.default\n                ? original\n                : await storageOperations.getDefault();\n            if (!defaultLocale) {\n                throw new NotFoundError(`Missing default locale.`);\n            }\n\n            const locale: I18NLocale = {\n                ...original,\n                ...input,\n                createdOn: original.createdOn ? original.createdOn : new Date().toISOString(),\n                webinyVersion: context.WEBINY_VERSION\n            };\n\n            try {\n                await runLifecycleEvent(\"beforeUpdate\", {\n                    context,\n                    plugins: localePlugins,\n                    original,\n                    data: locale\n                });\n                const result = await storageOperations.update({\n                    original,\n                    locale\n                });\n                if (locale.default && original.default !== locale.default) {\n                    await storageOperations.updateDefault({\n                        previous: defaultLocale,\n                        locale\n                    });\n                }\n                await runLifecycleEvent(\"afterUpdate\", {\n                    context,\n                    plugins: localePlugins,\n                    data: locale,\n                    original,\n                    locale: result\n                });\n                return locale;\n            } catch (ex) {\n                throw new WebinyError(\n                    ex.message || \"Could not update existing locale.\",\n                    ex.code || \"LOCALE_UPDATE_ERROR\",\n                    {\n                        original,\n                        input\n                    }\n                );\n            }\n        },\n        delete: async code => {\n            const { i18n, security } = context;\n\n            const permission = await security.getPermission(\"i18n.locale\");\n\n            if (!permission) {\n                throw new NotAuthorizedError();\n            }\n            const locale = await i18n.locales.get(code);\n            if (!locale) {\n                throw new NotFoundError(`Locale \"${code}\" not found.`);\n            }\n\n            if (locale.default) {\n                throw new WebinyError(\n                    \"Cannot delete default locale, please set another locale as default first.\"\n                );\n            }\n            const [allLocales] = await i18n.locales.list();\n            if (allLocales.length === 1) {\n                throw new WebinyError(\"Cannot delete the last locale.\");\n            }\n            try {\n                await runLifecycleEvent(\"beforeDelete\", {\n                    context,\n                    plugins: localePlugins,\n                    locale\n                });\n                await storageOperations.delete({\n                    locale\n                });\n                await runLifecycleEvent(\"afterDelete\", {\n                    context,\n                    plugins: localePlugins,\n                    locale\n                });\n                return locale;\n            } catch (ex) {\n                throw new WebinyError(\n                    ex.message || \"Could not delete existing locale.\",\n                    ex.code || \"LOCALE_DELETE_ERROR\",\n                    {\n                        locale\n                    }\n                );\n            }\n        }\n    };\n});\n"],"file":"locales.crud.js"}