{"version":3,"sources":["../../../src/operations/system/CmsSystemDynamoElastic.ts"],"names":["SYSTEM_SECONDARY_KEY","CmsSystemDynamoElastic","context","_context","partitionKey","tenant","tenancy","getCurrentTenant","WebinyError","id","constructor","get","db","system","read","configurations","query","PK","SK","create","data","ex","message","code","error","update"],"mappings":";;;;;;;;;;;AAAA;;AAEA;;;;;;AAMA,MAAMA,oBAAoB,GAAG,KAA7B;;AAEe,MAAMC,sBAAN,CAAmE;AAG3D,MAAPC,OAAO,GAAe;AAC9B,WAAO,KAAKC,QAAZ;AACH;;AAEuB,MAAZC,YAAY,GAAW;AAC/B,UAAMC,MAAM,GAAG,KAAKF,QAAL,CAAcG,OAAd,CAAsBC,gBAAtB,EAAf;;AACA,QAAI,CAACF,MAAL,EAAa;AACT,YAAM,IAAIG,cAAJ,CAAgB,iBAAhB,EAAmC,kBAAnC,CAAN;AACH;;AACD,WAAQ,KAAIH,MAAM,CAACI,EAAG,SAAtB;AACH;;AAEMC,EAAAA,WAAW,CAAC;AAAER,IAAAA;AAAF,GAAD,EAA+B;AAAA;AAC7C,SAAKC,QAAL,GAAgBD,OAAhB;AACH;;AAEe,QAAHS,GAAG,GAAuB;AACnC,UAAM;AAAEC,MAAAA;AAAF,QAAS,KAAKV,OAApB;AACA,UAAM,CAAC,CAACW,MAAD,CAAD,IAAa,MAAMD,EAAE,CAACE,IAAH,iCAClBC,wBAAeH,EAAf,EADkB;AAErBI,MAAAA,KAAK,EAAE;AACHC,QAAAA,EAAE,EAAE,KAAKb,YADN;AAEHc,QAAAA,EAAE,EAAElB;AAFD;AAFc,OAAzB;AAQA,WAAOa,MAAM,IAAI,IAAjB;AACH;;AAEkB,QAANM,MAAM,CAACC,IAAD,EAAiC;AAChD,UAAM;AAAER,MAAAA;AAAF,QAAS,KAAKV,OAApB;;AACA,QAAI;AACA,YAAMU,EAAE,CAACO,MAAH,iCACCJ,wBAAeH,EAAf,EADD;AAEFQ,QAAAA,IAAI;AACAH,UAAAA,EAAE,EAAE,KAAKb,YADT;AAEAc,UAAAA,EAAE,EAAElB;AAFJ,WAGGoB,IAHH;AAFF,SAAN;AAQH,KATD,CASE,OAAOC,EAAP,EAAW;AACT,YAAM,IAAIb,cAAJ,CACFa,EAAE,CAACC,OAAH,IAAc,0BADZ,EAEFD,EAAE,CAACE,IAAH,IAAW,qBAFT,EAGF;AACIC,QAAAA,KAAK,EAAEH,EADX;AAEID,QAAAA;AAFJ,OAHE,CAAN;AAQH;AACJ;;AAEkB,QAANK,MAAM,CAACL,IAAD,EAAiC;AAChD,UAAM;AAAER,MAAAA;AAAF,QAAS,KAAKV,OAApB;;AACA,QAAI;AACA,YAAMU,EAAE,CAACa,MAAH,iCACCV,wBAAeH,EAAf,EADD;AAEFI,QAAAA,KAAK,EAAE;AACHC,UAAAA,EAAE,EAAE,KAAKb,YADN;AAEHc,UAAAA,EAAE,EAAElB;AAFD,SAFL;AAMFoB,QAAAA;AANE,SAAN;AAQH,KATD,CASE,OAAOC,EAAP,EAAW;AACT,YAAM,IAAIb,cAAJ,CACFa,EAAE,CAACC,OAAH,IAAc,0BADZ,EAEFD,EAAE,CAACE,IAAH,IAAW,qBAFT,EAGF;AACIC,QAAAA,KAAK,EAAEH,EADX;AAEID,QAAAA;AAFJ,OAHE,CAAN;AAQH;AACJ;;AA5E6E","sourcesContent":["import WebinyError from \"@webiny/error\";\nimport { CmsContext, CmsSystem, CmsSystemStorageOperations } from \"@webiny/api-headless-cms/types\";\nimport configurations from \"../../configurations\";\n\ninterface ConstructorArgs {\n    context: CmsContext;\n}\n\nconst SYSTEM_SECONDARY_KEY = \"CMS\";\n\nexport default class CmsSystemDynamoElastic implements CmsSystemStorageOperations {\n    private readonly _context: CmsContext;\n\n    private get context(): CmsContext {\n        return this._context;\n    }\n\n    private get partitionKey(): string {\n        const tenant = this._context.tenancy.getCurrentTenant();\n        if (!tenant) {\n            throw new WebinyError(\"Tenant missing.\", \"TENANT_NOT_FOUND\");\n        }\n        return `T#${tenant.id}#SYSTEM`;\n    }\n\n    public constructor({ context }: ConstructorArgs) {\n        this._context = context;\n    }\n\n    public async get(): Promise<CmsSystem> {\n        const { db } = this.context;\n        const [[system]] = await db.read<CmsSystem>({\n            ...configurations.db(),\n            query: {\n                PK: this.partitionKey,\n                SK: SYSTEM_SECONDARY_KEY\n            }\n        });\n\n        return system || null;\n    }\n\n    public async create(data: CmsSystem): Promise<void> {\n        const { db } = this.context;\n        try {\n            await db.create({\n                ...configurations.db(),\n                data: {\n                    PK: this.partitionKey,\n                    SK: SYSTEM_SECONDARY_KEY,\n                    ...data\n                }\n            });\n        } catch (ex) {\n            throw new WebinyError(\n                ex.message || \"Could not create system.\",\n                ex.code || \"CREATE_SYSTEM_ERROR\",\n                {\n                    error: ex,\n                    data\n                }\n            );\n        }\n    }\n\n    public async update(data: CmsSystem): Promise<void> {\n        const { db } = this.context;\n        try {\n            await db.update({\n                ...configurations.db(),\n                query: {\n                    PK: this.partitionKey,\n                    SK: SYSTEM_SECONDARY_KEY\n                },\n                data\n            });\n        } catch (ex) {\n            throw new WebinyError(\n                ex.message || \"Could not update system.\",\n                ex.code || \"UPDATE_SYSTEM_ERROR\",\n                {\n                    error: ex,\n                    data\n                }\n            );\n        }\n    }\n}\n"],"file":"CmsSystemDynamoElastic.js"}